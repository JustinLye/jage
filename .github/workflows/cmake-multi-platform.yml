# This starter workflow is for a CMake project running on multiple platforms. There is a different starter workflow if you just want a single platform.
# See: https://github.com/actions/starter-workflows/blob/main/ci/cmake-single-platform.yml
name: JAGE Build and Test

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]

jobs:
  build-ci-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image: ${{ steps.image.outputs.image }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Detect Dockerfile changes
        id: dockerfile
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            git fetch origin "${{ github.base_ref }}" --depth=1
            if git diff --name-only "origin/${{ github.base_ref }}"..."${{ github.event.pull_request.head.sha }}" | grep -q '^docker/Dockerfile$'; then
              echo "changed=true" >> "$GITHUB_OUTPUT"
            else
              echo "changed=false" >> "$GITHUB_OUTPUT"
            fi
          else
            if git diff --name-only "${{ github.event.before }}" "${{ github.sha }}" | grep -q '^docker/Dockerfile$'; then
              echo "changed=true" >> "$GITHUB_OUTPUT"
            else
              echo "changed=false" >> "$GITHUB_OUTPUT"
            fi
          fi
      - name: Set image tag
        id: image
        shell: bash
        run: |
          owner_lc="${GITHUB_REPOSITORY_OWNER,,}"
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "image=ghcr.io/${owner_lc}/jage-ci:${{ github.event.pull_request.head.sha }}" >> "$GITHUB_OUTPUT"
          else
            echo "image=ghcr.io/${owner_lc}/jage-ci:${{ github.sha }}" >> "$GITHUB_OUTPUT"
          fi
          echo "OWNER_LC=${owner_lc}" >> "$GITHUB_ENV"
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push image (PR)
        if: ${{ github.event_name == 'pull_request' && steps.dockerfile.outputs.changed == 'true' }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile
          push: true
          tags: |
            ${{ steps.image.outputs.image }}
      - name: Build and push image (push)
        if: ${{ github.event_name == 'push' && steps.dockerfile.outputs.changed == 'true' }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ env.OWNER_LC }}/jage-ci:latest
            ${{ steps.image.outputs.image }}
      - name: Tag latest image with commit sha
        if: ${{ steps.dockerfile.outputs.changed == 'false' }}
        shell: bash
        run: |
          docker pull ghcr.io/${{ env.OWNER_LC }}/jage-ci:latest
          docker tag ghcr.io/${{ env.OWNER_LC }}/jage-ci:latest "${{ steps.image.outputs.image }}"
          docker push "${{ steps.image.outputs.image }}"

  build-and-test:
    needs: build-ci-image
    if: ${{ needs.build-ci-image.result == 'success' }}
    runs-on: ubuntu-latest
    container:
      image: ${{ needs.build-ci-image.outputs.image }}
      options: --user root
    strategy:
      fail-fast: true
      matrix:
        cpp_compiler: [g++, clang++]
        include:
          - cpp_compiler: g++
            c_compiler: gcc
            compiler_version: 14
          - cpp_compiler: clang++
            c_compiler: clang
            compiler_version: 18
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v4
      with:
        python-version: '3.13'
    - name: cache conan
      uses: actions/cache@v4
      if: ${{ !env.ACT }}
      with:
        path: |
          ~/.conan2
          ~/.cache/pip
        key: ${{ runner.os }}-conan-${{ matrix.c_compiler }}-${{ matrix.compiler_version }}-${{ hashFiles('conanfile.py', 'profiles/**') }}
        restore-keys: |
          ${{ runner.os }}-conan-${{ matrix.c_compiler }}-${{ matrix.compiler_version }}-
          ${{ runner.os }}-conan-
    - name: install conan virtual environment
      shell: bash
      run: |
        python3 -m venv conan
        source conan/bin/activate
        pip install conan
    - name: configure conan
      shell: bash
      run: |
        source conan/bin/activate
        conan install . -pr:a profiles/linux -pr:a profiles/${{ matrix.c_compiler }} -pr:a profiles/release -pr:a profiles/asan -pr:a profiles/ubsan --build=missing
    - name: configure cmake
      shell: bash
      run: |
        source conan/bin/activate
        cmake --preset conan-build-linux-${{ matrix.c_compiler }}-release-asan-ubsan
    - name: all
      shell: bash
      run: cmake --build build --target all
