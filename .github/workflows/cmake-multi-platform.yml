name: JAGE Build and Test

on:
  pull_request:
    branches: ["main"]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".gitignore"
      - "LICENSE"
  push:
    branches: ["main"]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".gitignore"
      - "LICENSE"
  workflow_dispatch:
  schedule:
    # 03:00 UTC = 21:00 US Central (UTC-6 standard; UTC-5 daylight)
    - cron: "0 3 * * *"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  build-ci-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image: ${{ steps.image.outputs.image }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Detect Dockerfile changes
        id: dockerfile
        if: ${{ !env.ACT }}
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            git fetch origin "${{ github.base_ref }}" --depth=1
            if git diff --name-only "origin/${{ github.base_ref }}"..."${{ github.event.pull_request.head.sha }}" | grep -q '^docker/Dockerfile$'; then
              echo "changed=true" >> "$GITHUB_OUTPUT"
            else
              echo "changed=false" >> "$GITHUB_OUTPUT"
            fi
          else
            if git diff --name-only "${{ github.event.before }}" "${{ github.sha }}" | grep -q '^docker/Dockerfile$'; then
              echo "changed=true" >> "$GITHUB_OUTPUT"
            else
              echo "changed=false" >> "$GITHUB_OUTPUT"
            fi
          fi
      - name: Set image tag
        id: image
        shell: bash
        run: |
          owner_lc="${GITHUB_REPOSITORY_OWNER,,}"
          if [[ "${ACT}" == "true" ]]; then
            echo "image=catthehacker/ubuntu:act-latest" >> "$GITHUB_OUTPUT"
            echo "OWNER_LC=${owner_lc}" >> "$GITHUB_ENV"
            exit 0
          fi
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "image=ghcr.io/${owner_lc}/jage-ci:${{ github.event.pull_request.head.sha }}" >> "$GITHUB_OUTPUT"
          else
            echo "image=ghcr.io/${owner_lc}/jage-ci:${{ github.sha }}" >> "$GITHUB_OUTPUT"
          fi
          echo "OWNER_LC=${owner_lc}" >> "$GITHUB_ENV"
      - name: Log in to GHCR
        if: ${{ !env.ACT }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push image (with latest tag)
        if: ${{ !env.ACT && github.event_name == 'push' && steps.dockerfile.outputs.changed == 'true' }}
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ env.OWNER_LC }}/jage-ci:latest
            ${{ steps.image.outputs.image }}
      - name: Build and push image (PR only)
        if: ${{ !env.ACT && github.event_name == 'pull_request' && steps.dockerfile.outputs.changed == 'true' }}
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile
          push: true
          tags: |
            ${{ steps.image.outputs.image }}
      - name: Tag latest image with commit sha
        if: ${{ !env.ACT && steps.dockerfile.outputs.changed == 'false' }}
        shell: bash
        run: |
          docker pull ghcr.io/${{ env.OWNER_LC }}/jage-ci:latest
          docker tag ghcr.io/${{ env.OWNER_LC }}/jage-ci:latest "${{ steps.image.outputs.image }}"
          docker push "${{ steps.image.outputs.image }}"

  # Determine build matrix based on event type
  setup-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set matrix based on event type
        id: set-matrix
        shell: bash
        run: |
          # Full matrix for all events (PR, push, schedule, manual)
          echo 'matrix={"include":[
            {"c_compiler":"gcc","build_type":"debug","sanitizer":"none","compiler_version":14},
            {"c_compiler":"gcc","build_type":"debug","sanitizer":"asan","compiler_version":14},
            {"c_compiler":"gcc","build_type":"debug","sanitizer":"ubsan","compiler_version":14},
            {"c_compiler":"gcc","build_type":"debug","sanitizer":"tsan","compiler_version":14},
            {"c_compiler":"gcc","build_type":"release","sanitizer":"none","compiler_version":14},
            {"c_compiler":"clang","build_type":"debug","sanitizer":"none","compiler_version":18},
            {"c_compiler":"clang","build_type":"debug","sanitizer":"asan","compiler_version":18},
            {"c_compiler":"clang","build_type":"debug","sanitizer":"ubsan","compiler_version":18},
            {"c_compiler":"clang","build_type":"debug","sanitizer":"tsan","compiler_version":18},
            {"c_compiler":"clang","build_type":"release","sanitizer":"none","compiler_version":18}
          ]}' | tr -d '\n' >> "$GITHUB_OUTPUT"

  build-and-test:
    needs: [build-ci-image, setup-matrix]
    if: ${{ needs.build-ci-image.result == 'success' }}
    runs-on: ubuntu-latest
    container:
      image: ${{ needs.build-ci-image.outputs.image }}
      options: --user root
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.setup-matrix.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
      - name: Set preset and profiles
        shell: bash
        run: |
          if [[ "${{ matrix.sanitizer }}" == "none" ]]; then
            echo "JAGE_CI_PRESET=conan-build-linux-${{ matrix.c_compiler }}-${{ matrix.build_type }}" >> "$GITHUB_ENV"
            echo "JAGE_CI_PROFILES=-pr:a profiles/linux -pr:a profiles/${{ matrix.c_compiler }} -pr:a profiles/${{ matrix.build_type }}" >> "$GITHUB_ENV"
          else
            echo "JAGE_CI_PRESET=conan-build-linux-${{ matrix.c_compiler }}-${{ matrix.build_type }}-${{ matrix.sanitizer }}" >> "$GITHUB_ENV"
            echo "JAGE_CI_PROFILES=-pr:a profiles/linux -pr:a profiles/${{ matrix.c_compiler }} -pr:a profiles/${{ matrix.build_type }} -pr:a profiles/${{ matrix.sanitizer }}" >> "$GITHUB_ENV"
          fi
      - name: Cache Conan packages
        uses: actions/cache@v4
        if: ${{ !env.ACT }}
        with:
          path: |
            ~/.conan2
            ~/.cache/pip
          key: conan-${{ matrix.c_compiler }}-${{ matrix.compiler_version }}-${{ matrix.build_type }}-${{ matrix.sanitizer }}-${{ hashFiles('conanfile.py', 'profiles/**') }}
          restore-keys: |
            conan-${{ matrix.c_compiler }}-${{ matrix.compiler_version }}-${{ matrix.build_type }}-${{ matrix.sanitizer }}-
            conan-${{ matrix.c_compiler }}-${{ matrix.compiler_version }}-${{ matrix.build_type }}-
            conan-${{ matrix.c_compiler }}-${{ matrix.compiler_version }}-
            conan-
      - name: Install Conan
        shell: bash
        run: |
          python3 -m venv conan
          source conan/bin/activate
          pip install conan
      - name: Configure Conan
        shell: bash
        run: |
          source conan/bin/activate
          conan install . $JAGE_CI_PROFILES --build=missing
      - name: Configure CMake
        shell: bash
        run: |
          source conan/bin/activate
          cmake --preset $JAGE_CI_PRESET
      - name: Build and test
        shell: bash
        run: cmake --build build --target all

  setup-matrix-windows:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set Windows matrix based on event type
        id: set-matrix
        shell: bash
        run: |
          # Full matrix for all events (PR, push, schedule, manual)
          echo 'matrix={"include":[
            {"build_type":"debug","extra_profile":"none"},
            {"build_type":"debug","extra_profile":"asan-msvc"},
            {"build_type":"debug","extra_profile":"sanity-checks"},
            {"build_type":"release","extra_profile":"none"}
          ]}' | tr -d '\n' >> "$GITHUB_OUTPUT"

  build-and-test-windows:
    needs: setup-matrix-windows
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.setup-matrix-windows.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
      - name: Set preset and profiles
        shell: pwsh
        run: |
          $profiles = "-pr:a profiles/windows -pr:a profiles/msvc -pr:a profiles/${{ matrix.build_type }} -s compiler.version=194 -c tools.microsoft.msbuild:vs_version=17"
          $build_dir = "build-windows-msvc-${{ matrix.build_type }}"
          if ("${{ matrix.extra_profile }}" -ne "none") {
            $profiles += " -pr:a profiles/${{ matrix.extra_profile }}"
            $build_dir += "-${{ matrix.extra_profile }}"
          }
          $preset = "conan-$build_dir"
          echo "JAGE_CI_PROFILES=$profiles" >> $env:GITHUB_ENV
          echo "JAGE_CI_PRESET=$preset" >> $env:GITHUB_ENV
          echo "JAGE_CI_BUILD_DIR=$build_dir" >> $env:GITHUB_ENV
      - name: Cache Conan packages
        uses: actions/cache@v4
        with:
          path: ~/.conan2
          key: conan-windows-msvc-${{ matrix.build_type }}-${{ matrix.extra_profile }}-${{ hashFiles('conanfile.py', 'profiles/**') }}
          restore-keys: |
            conan-windows-msvc-${{ matrix.build_type }}-${{ matrix.extra_profile }}-
      - name: Install Conan
        shell: pwsh
        run: |
          python -m venv .conan
          .\.conan\Scripts\Activate.ps1
          pip install conan
      - name: Configure Conan
        shell: pwsh
        run: |
          .\.conan\Scripts\Activate.ps1
          Invoke-Expression "conan install . $env:JAGE_CI_PROFILES --build=missing"
      - name: Configure CMake
        shell: cmd
        run: call "%JAGE_CI_BUILD_DIR%\generators\conanbuild.bat" && cmake --preset %JAGE_CI_PRESET%
      - name: Build and test
        shell: cmd
        run: call "%JAGE_CI_BUILD_DIR%\generators\conanbuild.bat" && cmake --build build --target all

  test-coverage:
    needs: build-ci-image
    if: ${{ github.event_name == 'schedule' && needs.build-ci-image.result == 'success' }}
    runs-on: ubuntu-latest
    container:
      image: ${{ needs.build-ci-image.outputs.image }}
      options: --user root
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
      - name: Cache Conan packages
        uses: actions/cache@v4
        if: ${{ !env.ACT }}
        with:
          path: |
            ~/.conan2
            ~/.cache/pip
          key: conan-gcc-14-coverage-${{ hashFiles('conanfile.py', 'profiles/**') }}
          restore-keys: |
            conan-gcc-14-coverage-
            conan-gcc-14-
            conan-
      - name: Install Conan
        shell: bash
        run: |
          python3 -m venv conan
          source conan/bin/activate
          pip install conan
      - name: Configure Conan
        shell: bash
        run: |
          source conan/bin/activate
          conan install . -pr:a profiles/coverage -pr:a profiles/linux -pr:a profiles/gcc -pr:a profiles/debug --build=missing
      - name: Configure CMake
        shell: bash
        run: |
          source conan/bin/activate
          cmake --preset conan-build-linux-gcc-debug
      - name: Build and run coverage
        shell: bash
        run: cmake --build build --target coverage
      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: build/coverage-report
          if-no-files-found: error
      - name: Upload coverage pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: build/coverage-report

  deploy-coverage:
    needs: test-coverage
    if: ${{ github.event_name == 'schedule' && needs.test-coverage.result == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}
    steps:
      - name: Deploy coverage to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4
