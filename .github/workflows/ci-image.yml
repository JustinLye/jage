name: Build CI Image

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]
    paths:
      - "docker/Dockerfile"

jobs:
  build-and-push:
    if: ${{ github.event_name == 'pull_request' || github.event_name == 'push' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Detect Dockerfile changes
        id: dockerfile
        if: ${{ github.event_name == 'pull_request' }}
        shell: bash
        run: |
          git fetch origin "${{ github.base_ref }}" --depth=1
          if git diff --name-only "origin/${{ github.base_ref }}"..."${{ github.event.pull_request.head.sha }}" | grep -q '^docker/Dockerfile$'; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Set lowercase owner
        shell: bash
        run: echo "OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> "$GITHUB_ENV"
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push (PR)
        uses: docker/build-push-action@v5
        if: ${{ github.event_name == 'pull_request' && steps.dockerfile.outputs.changed == 'true' }}
        with:
          context: .
          file: docker/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ env.OWNER_LC }}/jage-ci:${{ github.event.pull_request.head.sha }}
      - name: Tag latest image with PR head sha
        if: ${{ github.event_name == 'pull_request' && steps.dockerfile.outputs.changed == 'false' }}
        shell: bash
        run: |
          docker pull ghcr.io/${{ env.OWNER_LC }}/jage-ci:latest
          docker tag ghcr.io/${{ env.OWNER_LC }}/jage-ci:latest ghcr.io/${{ env.OWNER_LC }}/jage-ci:${{ github.event.pull_request.head.sha }}
          docker push ghcr.io/${{ env.OWNER_LC }}/jage-ci:${{ github.event.pull_request.head.sha }}
      - name: Build and push (main)
        uses: docker/build-push-action@v5
        if: ${{ github.event_name == 'push' }}
        with:
          context: .
          file: docker/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ env.OWNER_LC }}/jage-ci:latest
            ghcr.io/${{ env.OWNER_LC }}/jage-ci:${{ github.sha }}
